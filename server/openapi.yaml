openapi: 3.0.0
info:
  title: Capstone API
  version: 1.0.0
servers:
  - url: http://localhost:3000/api
    description: Development server
paths:
  /anon:
    post:
      summary: Retrieve or create an anonymous session.
      description: >
        Returns an anonymous session, or creates a new one if not found.
        Requires the `visitor` header
        Anonymous session's ID is hash combination of visitor ID (client fingerprint) and client IP address.
      tags:
        - Anon
      parameters:
        - name: visitor
          in: header
          required: true
          description: Unique visitor ID to identify the anonymous user.
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              description: No body required; visitorId is extracted from headers.
      responses:
        "200":
          description: Anonymous session found or created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AnonSessionResponse"
        "400":
          description: Missing visitorId or client IP
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/session-validate:
    post:
      summary: Validate session
      description: >
        Checks if the session is valid by verifying if it exists in cache or database.
        Requires an Authorization Bearer token in the header.
      tags:
        - Auth
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Session is valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        "401":
          description: Malformed, invalid or missing session ID
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/auth-only:
    post:
      summary: Authenticated session only
      description: Checks if the session in Authorization header is authenticated (Dedicated endpoints to run tests).
      tags:
        - Auth
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Session is valid and authenticated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        "401":
          description: Malformed, non-existent, missing or not an authenticated session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/google/callback:
    post:
      summary: Authenticate with Google
      description: >
        Authenticates a user using a Google ID token.
        The ID token should be provided in the Authorization header as a Bearer token.
      tags:
        - Auth
      security:
        - googleAuth: []
      responses:
        "200":
          description: Successfully authenticated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      id:
                        type: string
        "400":
          description: Invalid input or missing Google ID token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid Google token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/facebook/callback:
    post:
      summary: Authenticate with Facebook
      description: >
        Authenticates a user using a Facebook access token.
        The token should be provided in the Authorization header as a Bearer token.
      tags:
        - Auth
      security:
        - facebookAuth: []
      responses:
        "200":
          description: Successfully authenticated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      id:
                        type: string
        "400":
          description: Invalid input or missing Facebook access token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid Facebook token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/signout:
    post:
      summary: Sign out
      description: Signs out the authenticated user and deletes the session.
      tags:
        - Auth
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Session deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      affectedRows:
                        type: number
        "401":
          description: Malformed, invalid,  missing session or not an authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /chats:
    get:
      summary: Get paginated chats
      description: Retrieves paginated chats for the authenticated user.
      tags:
        - Chat
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
          description: Offset for pagination
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
          description: Limit for pagination
      responses:
        "200":
          description: List of chats
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      chats:
                        type: array
                        items:
                          $ref: "#/components/schemas/Chat"
                      hasMore:
                        type: boolean
        "400":
          description: Invalid offset or limit
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Create a new chat
      description: Creates a new chat for the authenticated user.
      tags:
        - Chat
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateChatRequest"
      responses:
        "200":
          description: Chat created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      id:
                        type: string
        "400":
          description: Missing required fields or invalid page URL or SQL errors
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      summary: Delete all chats of the authenticated user
      description: Deletes all chats for the authenticated user.
      tags:
        - Chat
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Chats deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      affectedRows:
                        type: number
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /chats/{id}:
    get:
      summary: Get chat by ID
      description: Retrieves a chat by its ID.
      tags:
        - Chat
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Chat ID
      responses:
        "200":
          description: Chat found
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/Chat"
        "400":
          description: Missing chat id
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Chat not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    put:
      summary: Update a chat by ID
      description: Updates a chat by its ID.
      tags:
        - Chat
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Chat ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateChatRequest"
      responses:
        "200":
          description: Chat updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      affectedRows:
                        type: number
        "400":
          description: Missing chat id or invalid update data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      summary: Delete a chat by ID
      description: Deletes a chat by its ID.
      tags:
        - Chat
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Chat ID
      responses:
        "200":
          description: Chat deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      affectedRows:
                        type: number
        "400":
          description: Missing chat id
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /chats/{chat_id}/messages:
    get:
      summary: Get all messages for a chat
      description: Retrieves all messages for a chat by chat_id.
      tags:
        - Message
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: chat_id
          required: true
          schema:
            type: string
          description: Chat ID
      responses:
        "200":
          description: List of messages
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      messages:
                        type: array
                        items:
                          $ref: "#/components/schemas/Message"
        "400":
          description: Missing chat_id
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Add a message to a chat
      description: Adds a message to a chat. Requires chat_id, role ('user' or 'assistant'), content, and model (optional) in the request.
      tags:
        - Message
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: chat_id
          required: true
          schema:
            type: string
          description: Chat ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateMessageRequest"
      responses:
        "200":
          description: Message added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      id:
                        type: string
        "400":
          description: Missing or invalid required fields (chat_id, role, or content) or SQL errors
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /test/bulk-insert-chats:
    post:
      summary: Bulk insert test chats
      description: >
        Bulk insert test chats for pagination testing.  
        Requires an authenticated session.  
        Only for testing purposes; not for production use.
      tags:
        - Test
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                count:
                  type: integer
                  default: 30
                  description: Number of test chats to insert
      responses:
        "200":
          description: Chats inserted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /feedback:
    post:
      summary: Submit feedback
      description: >
        Submit feedback from an authenticated user.  
        Requires a valid session and request body with stars (1-5), message ID and optional comment.
      tags:
        - Feedback
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateFeedbackRequest"
      responses:
        "200":
          description: Feedback submitted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      id:
                        type: string
        "400":
          description: Invalid input or SQL errors
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /pages:
    post:
      summary: Create a new page
      description: Inserts a new page record into the database.
      tags:
        - Page
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePageRequest"
      responses:
        "200":
          description: Page created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      id:
                        type: string
        "400":
          description: Invalid input or SQL errors
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    put:
      summary: Update a page by URL
      description: Updates a page record using its URL. Accepts partial updates for title, page_content, and pdf_content. The page_url must be provided as a query parameter.
      tags:
        - Page
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page_url
          required: true
          schema:
            type: string
            format: uri
          description: The URL of the page to update
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdatePageRequest"
      responses:
        "200":
          description: Page updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      affectedRows:
                        type: number
                        description: Number of rows affected (0 if nothing to update)
        "400":
          description: Missing or invalid page_url, or nothing to update
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /pages/{page_id}:
    get:
      summary: Get a page by ID
      description: Retrieves a page by its unique ID. Checks Redis cache first, then falls back to the database.
      tags:
        - Page
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: page_id
          required: true
          schema:
            type: string
          description: The unique ID of the page (hash of normalized URL)
      responses:
        "200":
          description: Page found
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      cached:
                        type: boolean
                        description: True if page was found in cache
                      page:
                        $ref: "#/components/schemas/Page"
        "400":
          description: Missing or invalid page_id
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Page not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /query/ask:
    post:
      summary: Handle user query with AI assistant
      description: >
        Processes user messages and generates AI assistant responses using OpenAI.
        Can handle both regular queries and summarization requests based on metadata.event.
        For summarize events, it first tries to get cached/stored summaries before generating new ones.
      tags:
        - Query
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QueryRequest"
            example:
              messages:
                - role: "user"
                  content: "What is this page about?"
              metadata:
                page_url: "https://example.com/article"
                max_tokens: 1000
                event: "ask"
      responses:
        "200":
          description: AI assistant response generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        description: AI assistant response content
                      usage:
                        type: object
                        nullable: true
                        properties:
                          prompt_tokens:
                            type: integer
                          completion_tokens:
                            type: integer
                          total_tokens:
                            type: integer
                        description: OpenAI usage statistics (null for cached responses)
                      model:
                        type: string
                        description: Model used for generation or "cached" for stored responses
              example:
                success: true
                data:
                  message: "This page appears to be about artificial intelligence and machine learning concepts..."
                  usage:
                    prompt_tokens: 150
                    completion_tokens: 75
                    total_tokens: 225
                  model: "gpt-4o-mini"
        "400":
          description: Invalid input - missing required fields or invalid page URL
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: External service error or internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /query/suggested-questions:
    post:
      summary: Generate suggested questions for page content
      description: >
        Generates 3 interesting questions based on provided web page content using OpenAI.
        Supports both English and Vietnamese languages.
        Questions are designed to be useful for readers of the page.
      tags:
        - Query
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateSuggestedQuestionRequest"
      responses:
        "200":
          description: Suggested questions generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      questions:
                        type: array
                        items:
                          type: string
                        maxItems: 3
                        description: Array of 3 generated questions
                      usage:
                        type: object
                        nullable: true
                        properties:
                          prompt_tokens:
                            type: integer
                          completion_tokens:
                            type: integer
                          total_tokens:
                            type: integer
                        description: OpenAI usage statistics
              example:
                success: true
                data:
                  questions:
                    - "What are the main types of machine learning algorithms?"
                    - "How does supervised learning differ from unsupervised learning?"
                    - "What are some real-world applications of machine learning?"
                  usage:
                    prompt_tokens: 120
                    completion_tokens: 45
                    total_tokens: 165
        "400":
          description: Missing page content or invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Failed to extract suggested questions or external service error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /query/captionize:
    post:
      summary: Generate captions for images
      description: >
        Generates detailed captions for an array of images using OpenAI's vision model.
        Uses provided article context to identify people, events, or relevant context in images.
        Processes multiple images concurrently with a limit of 5 concurrent requests.
      tags:
        - Query
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateImageCaptionRequest"
            example:
              sources:
                - "https://example.com/image1.jpg"
                - "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD..."
              context: "This article discusses the recent AI conference where industry leaders gathered to discuss the future of artificial intelligence..."
      responses:
        "200":
          description: Image captions generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      captions:
                        type: array
                        items:
                          type: string
                          nullable: true
                        description: Array of generated captions (null for failed images)
                      usage:
                        type: object
                        properties:
                          prompt_tokens:
                            type: integer
                          completion_tokens:
                            type: integer
                          total_tokens:
                            type: integer
                        description: Aggregated OpenAI usage statistics
              example:
                success: true
                data:
                  captions:
                    - "AI researchers presenting their latest findings at the technology conference"
                    - "Industry leaders engaged in a panel discussion about machine learning ethics"
                  usage:
                    prompt_tokens: 250
                    completion_tokens: 80
                    total_tokens: 330
        "400":
          description: Invalid input - missing sources or context
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: External service error or internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /notes:
    get:
      summary: Get notes for a page
      description: >
        Retrieves paginated notes for a specific page URL for the authenticated user.
        Requires page_url query parameter and supports pagination with offset and limit.
      tags:
        - Notes
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: page_url
          required: true
          schema:
            type: string
            format: uri
          description: URL of the page to get notes for
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
            minimum: 0
          description: Offset for pagination
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
            minimum: 1
          description: Limit for pagination
      responses:
        "200":
          description: Notes retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      notes:
                        type: array
                        items:
                          $ref: "#/components/schemas/Note"
                      hasMore:
                        type: boolean
                        description: Indicates if there are more notes available
        "400":
          description: Missing page_url, invalid page URL, or invalid pagination parameters
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Create a new note
      description: Creates a new note for the authenticated user on a specific page URL.
      tags:
        - Notes
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateNoteRequest"
            example:
              page_url: "https://example.com/article"
              note: "This is an important point about AI development that I want to remember."
      responses:
      "200":
        description: Note created successfully
        content:
          application/json:
            schema:
              type: object
              properties:
                success:
                  type: boolean
                data:
                  type: object
                  properties:
                    id:
                      type: string
                      description: Generated UUID for the created note
            example:
              success: true
              data:
                id: "550e8400-e29b-41d4-a716-446655440000"
        "400":
          description: Invalid input - missing required fields or invalid page URL
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /notes/all:
    get:
      summary: Get all notes for authenticated user
      description: >
        Retrieves paginated notes for the authenticated user across all pages.
        Supports pagination with offset and limit.
      tags:
        - Notes
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
            minimum: 0
          description: Offset for pagination
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
            minimum: 1
          description: Limit for pagination
      responses:
        "200":
          description: Notes retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      notes:
                        type: array
                        items:
                          $ref: "#/components/schemas/Note"
                      hasMore:
                        type: boolean
                        description: Indicates if there are more notes available
        "400":
          description: Invalid pagination parameters
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /notes/{id}:
    put:
      summary: Update a note by ID
      description: Updates a note by its ID. Only the owner can update their note.
      tags:
        - Notes
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: Note ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateNoteRequest"
            example:
              note: "Updated note content with additional insights about the topic."
      responses:
        "200":
          description: Note updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      affectedRows:
                        type: integer
                        description: Number of rows affected by the update
        "400":
          description: Invalid input - missing required fields
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Note not found or user doesn't own the note
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      summary: Delete a note by ID
      description: Deletes a note by its ID. Only the owner can delete their note.
      tags:
        - Notes
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
          description: Note ID
      responses:
        "200":
          description: Note deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      affectedRows:
                        type: integer
                        description: Number of rows affected by the deletion
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Note not found or user doesn't own the note
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: custom

    googleAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

    facebookAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Chat:
      type: object
      properties:
        id:
          type: string
        user_id:
          type: string
        page_url:
          type: string
        page_id:
          type: string
        title:
          type: string

    Message:
      type: object
      properties:
        id:
          type: string
        chat_id:
          type: string
        role:
          type: string
        content:
          type: string
        model:
          type: string

    Page:
      type: object
      properties:
        id:
          type: string
        page_url:
          type: string
        title:
          type: string
        page_content:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateChatRequest:
      type: object
      required:
        - page_url
        - title
      properties:
        page_url:
          type: string
        title:
          type: string

    UpdateChatRequest:
      type: object
      properties:
        title:
          type: string

    CreateMessageRequest:
      type: object
      required:
        - role
        - content
      properties:
        role:
          type: string
        content:
          type: string
        model:
          type: string

    CreateFeedbackRequest:
      type: object
      required:
        - stars
        - message_id
      properties:
        stars:
          type: integer
          minimum: 1
          maximum: 5
          description: Rating from 1 to 5
        comment:
          type: string
          description: Optional feedback comment
        message_id:
          type: number
          description: Required message ID of the feedback

    CreatePageRequest:
      type: object
      required:
        - page_url
        - page_content
      properties:
        page_url:
          type: string
        title:
          type: string
          default: Untitled Page
        page_content:
          type: string
        pdf_content:
          type: string

    UpdatePageRequest:
      type: object
      properties:
        title:
          type: string
          description: New title for the page
        page_content:
          type: string
          description: New page content
        pdf_content:
          type: string
          description: New PDF content (with metadata prepended)

    QueryRequest:
      type: object
      required:
        - messages
        - metadata
      properties:
        messages:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - role
              - content
            properties:
              role:
                type: string
                enum: ["user", "assistant", "system"]
              content:
                type: string
                minLength: 1
        metadata:
          type: object
          required:
            - page_url
            - max_tokens
          properties:
            page_url:
              type: string
              format: uri
              description: URL of the page being queried
            max_tokens:
              type: integer
              minimum: 1
              maximum: 4096
              description: Maximum tokens for AI response
            event:
              type: string
              default: "ask"
              description: Type of query event (e.g., "ask", "summarize")

    CreateImageCaptionRequest:
      type: object
      required:
        - sources
        - context
      properties:
        sources:
          type: array
          minItems: 1
          items:
            type: string
          description: Array of image URLs or base64 encoded images
        context:
          type: string
          minLength: 1
          description: Article content to provide context for image captioning

    CreateSuggestedQuestionRequest:
      type: object
      required:
        - pageContent
      properties:
        pageContent:
          type: object
          required:
            - content
          properties:
            title:
              type: string
              description: Page title
            content:
              type: string
              description: Page content (first 3000 characters used)
            pdfContent:
              type: string
              description: >
                Full extracted PDF content from the page with metadata prepended.
                (first 5000 characters used)
        language:
          type: string
          enum: ["en", "vi"]
          default: "en"
          description: Language for generated questions
      example:
        pageContent:
          title: "Introduction to Machine Learning"
          content: "Machine learning is a subset of artificial intelligence that focuses on..."
        language: "en"

    AnonSessionResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            id:
              type: string
            anon_query_count:
              type: integer

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string

    Note:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier for the note
        user_id:
          type: string
          description: ID of the user who created the note
        page_url:
          type: string
          format: uri
          description: URL of the page this note belongs to
        note:
          type: string
          description: The note content
        created_at:
          type: string
          format: date-time
          description: Timestamp when the note was created
        updated_at:
          type: string
          format: date-time
          description: Timestamp when the note was last updated

    CreateNoteRequest:
      type: object
      required:
        - page_url
        - note
      properties:
        page_url:
          type: string
          format: uri
          description: URL of the page to create note for
          minLength: 1
        note:
          type: string
          description: Content of the note
          minLength: 1

    UpdateNoteRequest:
      type: object
      required:
        - note
      properties:
        note:
          type: string
          description: Updated content of the note
          minLength: 1
