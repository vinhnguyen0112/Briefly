openapi: 3.0.0
info:
  title: Capstone API
  version: 1.0.0
servers:
  - url: https://dev-capstone-2025.coccoc.com/api
    description: Development server
paths:
  /anon:
    post:
      summary: Retrieve or create an anonymous session.
      description: >
        Returns an anonymous session, or creates a new one if not found.
        Requires the `visitor` header
        Anonymous session's ID is hash combination of visitor ID (client fingerprint) and client IP address.
      tags:
        - Anon
      parameters:
        - name: visitor
          in: header
          required: true
          description: Unique visitor ID to identify the anonymous user.
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              description: No body required; visitorId is extracted from headers.
      responses:
        "200":
          description: Anonymous session found or created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                      anon_query_count:
                        type: integer
        "400":
          description: Missing visitorId or client IP
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/session-validate:
    post:
      summary: Validate session
      description: >
        Checks if the session is valid by verifying if it exists in cache or database.
        Requires an Authorization Bearer token in the header.
      tags:
        - Auth
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Session is valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        "401":
          description: Malformed, invalid or missing session ID
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/auth-only:
    post:
      summary: Authenticated session only
      description: Checks if the session in Authorization header is authenticated (Dedicated endpoints to run tests).
      tags:
        - Auth
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Session is valid and authenticated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        "401":
          description: Malformed, non-existent, missing or not an authenticated session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/google/callback:
    post:
      summary: Authenticate with Google
      description: >
        Authenticates a user using a Google ID token.
        The ID token should be provided in the Authorization header as a Bearer token.
      tags:
        - Auth
      security:
        - googleAuth:: []
      responses:
        "200":
          description: Successfully authenticated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      id:
                        type: string
        "400":
          description: Invalid input or missing Google ID token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid Google token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/facebook/callback:
    post:
      summary: Authenticate with Facebook
      description: >
        Authenticates a user using a Facebook access token.
        The token should be provided in the Authorization header as a Bearer token.
      tags:
        - Auth
      security:
        - facebookAuth: []
      responses:
        "200":
          description: Successfully authenticated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      id:
                        type: string
        "400":
          description: Invalid input or missing Facebook access token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid Facebook token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /auth/signout:
    post:
      summary: Sign out
      description: Signs out the authenticated user and deletes the session.
      tags:
        - Auth
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Session deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      affectedRows:
                        type: number
        "401":
          description: Malformed, invalid,  missing session or not an authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /chats:
    get:
      summary: Get paginated chats
      description: Retrieves paginated chats for the authenticated user.
      tags:
        - Chat
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: offset
          schema:
            type: integer
            default: 0
          description: Offset for pagination
        - in: query
          name: limit
          schema:
            type: integer
            default: 20
          description: Limit for pagination
      responses:
        "200":
          description: List of chats
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      chats:
                        type: array
                        items:
                          $ref: "#/components/schemas/Chat"
                      hasMore:
                        type: boolean
        "400":
          description: Invalid offset or limit
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Create a new chat
      description: Creates a new chat for the authenticated user.
      tags:
        - Chat
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateChatRequest"
      responses:
        "200":
          description: Chat created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      id:
                        type: string
        "400":
          description: Missing required fields or invalid page URL or SQL errors
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      summary: Delete all chats of the authenticated user
      description: Deletes all chats for the authenticated user.
      tags:
        - Chat
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Chats deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      affectedRows:
                        type: number
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /chats/{id}:
    get:
      summary: Get chat by ID
      description: Retrieves a chat by its ID.
      tags:
        - Chat
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Chat ID
      responses:
        "200":
          description: Chat found
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: "#/components/schemas/Chat"
        "400":
          description: Missing chat id
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Chat not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    put:
      summary: Update a chat by ID
      description: Updates a chat by its ID.
      tags:
        - Chat
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Chat ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateChatRequest"
      responses:
        "200":
          description: Chat updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      affectedRows:
                        type: number
        "400":
          description: Missing chat id or invalid update data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    delete:
      summary: Delete a chat by ID
      description: Deletes a chat by its ID.
      tags:
        - Chat
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: Chat ID
      responses:
        "200":
          description: Chat deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      affectedRows:
                        type: number
        "400":
          description: Missing chat id
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /chats/{chat_id}/messages:
    get:
      summary: Get all messages for a chat
      description: Retrieves all messages for a chat by chat_id.
      tags:
        - Message
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: chat_id
          required: true
          schema:
            type: string
          description: Chat ID
      responses:
        "200":
          description: List of messages
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      messages:
                        type: array
                        items:
                          $ref: "#/components/schemas/Message"
        "400":
          description: Missing chat_id
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
    post:
      summary: Add a message to a chat
      description: Adds a message to a chat. Requires chat_id, role ('user' or 'assistant'), content, and model (optional) in the request.
      tags:
        - Message
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: chat_id
          required: true
          schema:
            type: string
          description: Chat ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateMessageRequest"
      responses:
        "200":
          description: Message added successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      id:
                        type: string
        "400":
          description: Missing or invalid required fields (chat_id, role, or content) or SQL errors
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /test/bulk-insert-chats:
    post:
      summary: Bulk insert test chats
      description: >
        Bulk insert test chats for pagination testing.  
        Requires an authenticated session.  
        Only for testing purposes; not for production use.
      tags:
        - Test
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                count:
                  type: integer
                  default: 30
                  description: Number of test chats to insert
      responses:
        "200":
          description: Chats inserted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /feedback:
    post:
      summary: Submit feedback
      description: >
        Submit feedback from an authenticated user.  
        Requires a valid session and request body with stars (1-5), message ID and optional comment.
      tags:
        - Feedback
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateFeedbackRequest"
      responses:
        "200":
          description: Feedback submitted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      id:
                        type: string
        "400":
          description: Invalid input or SQL errors
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /pages:
    post:
      summary: Create a new page
      description: Inserts a new page record into the database.
      tags:
        - Page
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePageRequest"
      responses:
        "200":
          description: Page created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      id:
                        type: string
        "400":
          description: Invalid input or SQL errors
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /page-summaries:
    post:
      summary: Create a page summary
      description: >
        Creates and stores a summary for a specific page URL in a given language.
        The page URL is normalized and a page ID is generated based on the URL hash.
        The summary is also cached in Redis for faster retrieval.
      tags:
        - Page Summary
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreatePageSummaryRequest"
            example:
              page_url: "https://example.com/article"
              language: "en"
              summary: "This article discusses the latest developments in artificial intelligence and machine learning technologies."
      responses:
        "200":
          description: Page summary created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      id:
                        type: string
                        description: Generated ID for the page summary record
              example:
                success: true
                message: "Page summary saved successfully"
                data:
                  id: "abc123def456"
        "400":
          description: Invalid input - missing required fields or validation errors
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /query/ask:
    post:
      summary: Handle user query with AI assistant
      description: >
        Processes user messages and generates AI assistant responses using OpenAI.
        Can handle both regular queries and summarization requests based on metadata.event.
        For summarize events, it first tries to get cached/stored summaries before generating new ones.
      tags:
        - Query
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/QueryRequest"
            example:
              messages:
                - role: "user"
                  content: "What is this page about?"
              metadata:
                page_url: "https://example.com/article"
                max_tokens: 1000
                event: "ask"
      responses:
        "200":
          description: AI assistant response generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                        description: AI assistant response content
                      usage:
                        type: object
                        nullable: true
                        properties:
                          prompt_tokens:
                            type: integer
                          completion_tokens:
                            type: integer
                          total_tokens:
                            type: integer
                        description: OpenAI usage statistics (null for cached responses)
                      model:
                        type: string
                        description: Model used for generation or "cached" for stored responses
              example:
                success: true
                data:
                  message: "This page appears to be about artificial intelligence and machine learning concepts..."
                  usage:
                    prompt_tokens: 150
                    completion_tokens: 75
                    total_tokens: 225
                  model: "gpt-4o-mini"
        "400":
          description: Invalid input - missing required fields or invalid page URL
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: External service error or internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /query/suggested-questions:
    post:
      summary: Generate suggested questions for page content
      description: >
        Generates 3 interesting questions based on provided web page content using OpenAI.
        Supports both English and Vietnamese languages.
        Questions are designed to be useful for readers of the page.
      tags:
        - Query
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - pageContent
              properties:
                pageContent:
                  type: object
                  required:
                    - content
                  properties:
                    title:
                      type: string
                      description: Page title
                    content:
                      type: string
                      description: Page content (first 3000 characters used)
                language:
                  type: string
                  enum: ["en", "vi"]
                  default: "en"
                  description: Language for generated questions
            example:
              pageContent:
                title: "Introduction to Machine Learning"
                content: "Machine learning is a subset of artificial intelligence that focuses on..."
              language: "en"
      responses:
        "200":
          description: Suggested questions generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      questions:
                        type: array
                        items:
                          type: string
                        maxItems: 3
                        description: Array of 3 generated questions
                      usage:
                        type: object
                        nullable: true
                        properties:
                          prompt_tokens:
                            type: integer
                          completion_tokens:
                            type: integer
                          total_tokens:
                            type: integer
                        description: OpenAI usage statistics
              example:
                success: true
                data:
                  questions:
                    - "What are the main types of machine learning algorithms?"
                    - "How does supervised learning differ from unsupervised learning?"
                    - "What are some real-world applications of machine learning?"
                  usage:
                    prompt_tokens: 120
                    completion_tokens: 45
                    total_tokens: 165
        "400":
          description: Missing page content or invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Failed to extract suggested questions or external service error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /query/captionize:
    post:
      summary: Generate captions for images
      description: >
        Generates detailed captions for an array of images using OpenAI's vision model.
        Uses provided article context to identify people, events, or relevant context in images.
        Processes multiple images concurrently with a limit of 5 concurrent requests.
      tags:
        - Query
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateImageCaptionRequest"
            example:
              sources:
                - "https://example.com/image1.jpg"
                - "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD..."
              context: "This article discusses the recent AI conference where industry leaders gathered to discuss the future of artificial intelligence..."
      responses:
        "200":
          description: Image captions generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      captions:
                        type: array
                        items:
                          type: string
                          nullable: true
                        description: Array of generated captions (null for failed images)
                      usage:
                        type: object
                        properties:
                          prompt_tokens:
                            type: integer
                          completion_tokens:
                            type: integer
                          total_tokens:
                            type: integer
                        description: Aggregated OpenAI usage statistics
              example:
                success: true
                data:
                  captions:
                    - "AI researchers presenting their latest findings at the technology conference"
                    - "Industry leaders engaged in a panel discussion about machine learning ethics"
                  usage:
                    prompt_tokens: 250
                    completion_tokens: 80
                    total_tokens: 330
        "400":
          description: Invalid input - missing sources or context
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized or invalid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: External service error or internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: custom

    googleAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

    facebookAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    Chat:
      type: object
      properties:
        id:
          type: string
        user_id:
          type: string
        page_url:
          type: string
        page_id:
          type: string
        title:
          type: string

    Message:
      type: object
      properties:
        id:
          type: string
        chat_id:
          type: string
        role:
          type: string
        content:
          type: string
        model:
          type: string

    Page:
      type: object
      properties:
        id:
          type: string
        page_url:
          type: string
        title:
          type: string
        page_content:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    PageSummary:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier for the page summary
        page_id:
          type: string
          description: Generated hash ID based on normalized page URL
        language:
          type: string
          description: Language code for the summary
        summary:
          type: string
          description: Summary content
        created_at:
          type: string
          format: date-time
          description: Timestamp when the summary was created
        updated_at:
          type: string
          format: date-time
          description: Timestamp when the summary was last updated

    CreateChatRequest:
      type: object
      required:
        - page_url
        - title
      properties:
        page_url:
          type: string
        title:
          type: string

    UpdateChatRequest:
      type: object
      properties:
        title:
          type: string

    CreateMessageRequest:
      type: object
      required:
        - role
        - content
      properties:
        role:
          type: string
        content:
          type: string
        model:
          type: string

    CreateFeedbackRequest:
      type: object
      required:
        - stars
        - message_id
      properties:
        stars:
          type: integer
          minimum: 1
          maximum: 5
          description: Rating from 1 to 5
        comment:
          type: string
          description: Optional feedback comment
        message_id:
          type: number
          description: Required message ID of the feedback

    CreatePageRequest:
      type: object
      required:
        - page_url
        - page_content
      properties:
        page_url:
          type: string
        title:
          type: string
          default: Untitled Page
        page_content:
          type: string

    CreatePageSummaryRequest:
      type: object
      required:
        - page_url
        - language
        - summary
      properties:
        page_url:
          type: string
          format: uri
          description: URL of the page to create summary for
        language:
          type: string
          description: Language code for the summary (e.g., "en", "vi")
          minLength: 2
          maxLength: 5
        summary:
          type: string
          description: Summary content for the page
          minLength: 1

    QueryRequest:
      type: object
      required:
        - messages
        - metadata
      properties:
        messages:
          type: array
          minItems: 1
          items:
            type: object
            required:
              - role
              - content
            properties:
              role:
                type: string
                enum: ["user", "assistant", "system"]
              content:
                type: string
                minLength: 1
        metadata:
          type: object
          required:
            - page_url
            - max_tokens
          properties:
            page_url:
              type: string
              format: uri
              description: URL of the page being queried
            max_tokens:
              type: integer
              minimum: 1
              maximum: 4096
              description: Maximum tokens for AI response
            event:
              type: string
              default: "ask"
              description: Type of query event (e.g., "ask", "summarize")

    CreateImageCaptionRequest:
      type: object
      required:
        - sources
        - context
      properties:
        sources:
          type: array
          minItems: 1
          items:
            type: string
          description: Array of image URLs or base64 encoded images
        context:
          type: string
          minLength: 1
          description: Article content to provide context for image captioning

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
